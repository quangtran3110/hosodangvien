<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Phiếu Bổ Sung Hồ Sơ Đảng Viên</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
      body { background-color: #f8f9fa; padding: 20px; }
      .container { max-width: 800px; background: white; padding: 30px; border-radius: 10px; box-shadow: 0 4px 6px rgba(0,0,0,0.1); }
      .hidden-section { display: none; background-color: #f1f3f5; padding: 15px; border-radius: 5px; margin-top: 10px;}
      .header-title { color: #d63384; font-weight: bold; text-align: center; text-transform: uppercase; }
    </style>
</head>
<body>
    <div class="container">
      <h4 class="header-title mb-4">Phiếu Bổ Sung Hồ Sơ Đảng Viên</h4>
      <form id="dangVienForm">
        <h5 class="border-bottom pb-2">I. Thông tin chung</h5>
        <div class="row mb-3">
          <div class="col-md-8">
            <label class="form-label">Họ và tên đang dùng (viết in hoa)</label>
            <input type="text" class="form-control" id="hoTen" required placeholder="NGUYỄN VĂN A">
          </div>
          <div class="col-md-4">
            <label class="form-label">Số LL</label>
            <input type="text" class="form-control" id="soLL" required>
          </div>
        </div>

        <h5 class="border-bottom pb-2 mt-4">II. Nơi ở và Công tác</h5>
        <div class="form-check form-switch mb-3">
          <input class="form-check-input" type="checkbox" id="checkWorkChange" onchange="toggleSection('sec-work', this)">
          <label class="form-check-label fw-bold" for="checkWorkChange">Có thay đổi về nơi ở, công tác?</label>
        </div>
        <div id="sec-work" class="hidden-section">
          <input type="text" class="form-control mb-2" id="noiO" placeholder="Nơi ở mới...">
          <input type="text" class="form-control" id="congTac" placeholder="Đơn vị công tác mới...">
        </div>

        <h5 class="border-bottom pb-2 mt-4">III. Quan hệ gia đình</h5>
        <div class="form-check form-switch mb-3">
          <input class="form-check-input" type="checkbox" id="checkFamilyChange" onchange="toggleSection('sec-family', this)">
          <label class="form-check-label fw-bold" for="checkFamilyChange">Có thay đổi về gia đình?</label>
        </div>
        <div id="sec-family" class="hidden-section">
          <table class="table table-bordered bg-white" id="familyTable">
            <thead><tr><th>Quan hệ</th><th>Họ tên</th><th>Năm sinh</th><th>Nội dung</th><th>Xóa</th></tr></thead>
            <tbody></tbody>
          </table>
          <button type="button" class="btn btn-sm btn-success" onclick="addFamilyRow()">+ Thêm dòng</button>
        </div>

        <div class="d-grid gap-2 mt-5">
          <button type="submit" class="btn btn-primary btn-lg" id="btnSubmit">GỬI THÔNG TIN</button>
        </div>
      </form>
    </div>

    <script>
      // !!! QUAN TRỌNG: DÁN LINK WEB APP (EXEC) CỦA BẠN VÀO DÒNG DƯỚI ĐÂY !!!
      const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbxDzF7a0csELHqGC4aV4R1VcNrwEOvjSnuA5L4B46mEFL_EnYdUlQsH15Hp802HkFuoTQ/exec"; 

      function toggleSection(id, cb) {
        document.getElementById(id).style.display = cb.checked ? 'block' : 'none';
      }

      function addFamilyRow() {
        var table = document.getElementById("familyTable").getElementsByTagName('tbody')[0];
        var row = table.insertRow();
        row.innerHTML = `
          <td><select class="form-select form-select-sm"><option>Con</option><option>Vợ/Chồng</option><option>Cha/Mẹ</option></select></td>
          <td><input type="text" class="form-control form-control-sm"></td>
          <td><input type="number" class="form-control form-control-sm"></td>
          <td><input type="text" class="form-control form-control-sm"></td>
          <td><button type="button" class="btn btn-danger btn-sm" onclick="this.closest('tr').remove()">X</button></td>`;
      }

      document.getElementById('dangVienForm').addEventListener('submit', function(e) {
        e.preventDefault();
        var btn = document.getElementById("btnSubmit");
        btn.innerHTML = "Đang gửi..."; btn.disabled = true;

        // Thu thập dữ liệu
        var data = {
          hoTen: document.getElementById('hoTen').value,
          soLL: document.getElementById('soLL').value,
          checkWorkChange: document.getElementById('checkWorkChange').checked,
          noiO: document.getElementById('noiO').value,
          congTac: document.getElementById('congTac').value,
          checkFamilyChange: document.getElementById('checkFamilyChange').checked,
          familyRows: []
        };

        if (data.checkFamilyChange) {
           var rows = document.getElementById("familyTable").querySelectorAll('tbody tr');
           rows.forEach(r => {
             data.familyRows.push({
               quanHe: r.cells[0].querySelector('select').value,
               hoTen: r.cells[1].querySelector('input').value,
               namSinh: r.cells[2].querySelector('input').value,
               noiDung: r.cells[3].querySelector('input').value
             });
           });
        }

        // Gửi bằng fetch API
        fetch(SCRIPT_URL, {
          method: 'POST',
          body: JSON.stringify(data),
          mode: 'no-cors' // Quan trọng: chế độ này giúp không bị lỗi CORS chặn
        }).then(() => {
            alert("Đã gửi thành công!");
            document.getElementById('dangVienForm').reset();
            btn.innerHTML = "GỬI THÔNG TIN"; btn.disabled = false;
            document.querySelectorAll('.hidden-section').forEach(e => e.style.display = 'none');
        }).catch(err => {
            alert("Lỗi kết nối: " + err);
            btn.disabled = false;
        });
      });
    </script>
</body>
</html>